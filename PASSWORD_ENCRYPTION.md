# Шифрование паролей в системе Ландыш

## Обзор

В системе используются три типа учетных данных с разными механизмами хранения и шифрования:

1. **Пароли пользователей системы** (Django User)
2. **Пароли администраторов кластера** (ServerConnection)
3. **Пароли администраторов информационных баз** (не хранятся в БД)

---

## 1. Пароли пользователей системы (Django User)

### Механизм хранения
- **Модель**: `django.contrib.auth.models.User`
- **Поле**: `password` (CharField)
- **Тип шифрования**: Хеширование (одностороннее)

### Алгоритм
Django использует **PBKDF2** (Password-Based Key Derivation Function 2) по умолчанию:
- Алгоритм: PBKDF2 с SHA256
- Итерации: 260,000 (в Django 4.2+)
- Соль: уникальная для каждого пароля
- Формат: `pbkdf2_sha256$260000$<salt>$<hash>`

### Особенности
- ✅ **Одностороннее хеширование** - пароль невозможно восстановить
- ✅ **Уникальная соль** для каждого пароля
- ✅ **Адаптивное количество итераций** - защита от брутфорса
- ✅ **Валидация паролей** через `AUTH_PASSWORD_VALIDATORS`:
  - Минимальная длина
  - Сложность (буквы, цифры, спецсимволы)
  - Проверка на распространенные пароли
  - Проверка на схожесть с данными пользователя

### Пример хранения
```
pbkdf2_sha256$260000$abc123xyz$def456uvw...
```

### Где используется
- Аутентификация пользователей в системе
- Смена пароля через форму
- Принудительная смена пароля администратором

---

## 2. Пароли администраторов кластера

### Механизм хранения
- **Модель**: `clusters.models.ServerConnection`
- **Поле**: `cluster_password` (encrypted CharField)
- **Тип шифрования**: Симметричное шифрование (AES)

### Библиотека
Используется **django-cryptography** версии 1.1:
```python
from django_cryptography.fields import encrypt

cluster_password = encrypt(models.CharField(max_length=255, blank=True, null=True))
```

### Алгоритм
- **Тип**: AES (Advanced Encryption Standard)
- **Режим**: GCM (Galois/Counter Mode) - обеспечивает аутентификацию
- **Ключ**: Используется `SECRET_KEY` из настроек Django (или специальный ключ для cryptography)
- **Двустороннее шифрование**: пароль можно расшифровать

### Особенности
- ✅ **Шифрование на уровне БД** - данные шифруются перед записью
- ✅ **Автоматическое расшифрование** при чтении из БД
- ✅ **Прозрачное использование** - код работает с обычными строками
- ⚠️ **Двустороннее шифрование** - пароль можно восстановить при наличии ключа
- ⚠️ **Зависимость от SECRET_KEY** - при потере ключа данные не восстановить

### Где используется
- Хранение в модели `ServerConnection`
- Передача в RAC команды для аутентификации
- Сохранение при создании/редактировании подключения

### Пример использования
```python
# Сохранение
connection.cluster_password = "my_password"
connection.save()  # Автоматически шифруется

# Чтение
password = connection.cluster_password  # Автоматически расшифровывается
```

---

## 3. Пароли администраторов информационных баз

### Механизм хранения
- **Модель**: НЕ хранятся в базе данных
- **Хранилище**: `localStorage` браузера (клиентская сторона)
- **Тип шифрования**: НЕ шифруются (открытый текст в JSON)

### Формат хранения
```javascript
// Ключ в localStorage
`infobase_credentials_${connectionId}_${infobaseUuid}`

// Значение (JSON)
{
    "user": "Администратор",
    "password": "пароль_в_открытом_виде"
}
```

### Особенности
- ⚠️ **НЕ шифруются** - хранятся в открытом виде
- ⚠️ **Только на клиенте** - не передаются на сервер для хранения
- ⚠️ **Зависимость от браузера** - данные теряются при очистке localStorage
- ✅ **Изоляция по пользователю** - каждый пользователь видит только свои данные
- ✅ **Изоляция по ИБ** - отдельные учетные данные для каждой ИБ

### Где используется
- Временное хранение для удобства пользователя
- Автозаполнение формы при повторном открытии свойств ИБ
- Передача в RAC команды только во время выполнения запросов

### Функции JavaScript
```javascript
// Сохранение
saveInfobaseCredentialsToStorage(connectionId, infobaseUuid, user, password);

// Загрузка
const creds = loadInfobaseCredentialsFromStorage(connectionId, infobaseUuid);
// Возвращает: { user: "...", password: "..." }
```

### Безопасность
- ⚠️ **Риск**: Пароли доступны через DevTools браузера
- ⚠️ **Риск**: Могут быть украдены через XSS атаки
- ✅ **Смягчение**: Данные не передаются на сервер для постоянного хранения
- ✅ **Смягчение**: Используются только для текущей сессии

---

## Сравнительная таблица

| Параметр | Пользователи системы | Администраторы кластера | Администраторы ИБ |
|----------|---------------------|------------------------|-------------------|
| **Хранилище** | База данных (Django User) | База данных (ServerConnection) | localStorage браузера |
| **Тип шифрования** | Хеширование (PBKDF2) | Симметричное (AES-GCM) | Не шифруется |
| **Восстановление** | Невозможно | Возможно (с ключом) | Доступно в браузере |
| **Одностороннее** | ✅ Да | ❌ Нет | ❌ Нет |
| **Безопасность** | ✅ Высокая | ✅ Средняя | ⚠️ Низкая |
| **Использование** | Аутентификация в системе | RAC команды | RAC команды |

---

## Рекомендации по безопасности

### Для паролей пользователей системы
- ✅ Используется стандартный механизм Django - безопасно
- ✅ Регулярно обновляйте Django для получения последних исправлений
- ✅ Используйте сильные пароли через валидаторы

### Для паролей администраторов кластера
- ✅ Храните `SECRET_KEY` в безопасном месте (переменные окружения)
- ✅ Не коммитьте `SECRET_KEY` в репозиторий
- ✅ Регулярно ротируйте ключи (требует перешифрования данных)
- ⚠️ Ограничьте доступ к базе данных

### Для паролей администраторов ИБ
- ⚠️ **Рекомендация**: Рассмотреть возможность шифрования в localStorage
- ⚠️ **Рекомендация**: Использовать Web Crypto API для шифрования на клиенте
- ⚠️ **Рекомендация**: Очищать localStorage при выходе из системы
- ✅ Текущая реализация приемлема, так как данные не хранятся на сервере

---

## Технические детали

### django-cryptography
Библиотека использует:
- **Fernet** (симметричное шифрование) или **AES-GCM**
- Ключ берется из `SECRET_KEY` или настраивается отдельно
- Автоматическое управление ключами и версионирование

### SECRET_KEY
- Используется для подписи сессий, CSRF токенов
- Используется для шифрования данных django-cryptography
- **КРИТИЧНО**: Не раскрывайте и не теряйте этот ключ
- Генерируется автоматически при создании проекта Django

### localStorage
- Хранилище браузера (5-10 МБ обычно)
- Сохраняется между сессиями
- Очищается пользователем или через JavaScript
- Доступно только для домена, который его создал

---

## Миграция и обновление

### При смене SECRET_KEY
Если нужно сменить `SECRET_KEY`:
1. Старые зашифрованные данные (пароли кластера) не смогут быть расшифрованы
2. Потребуется перешифрование всех данных
3. Пользователям нужно будет заново ввести пароли администраторов кластера

### При обновлении django-cryptography
- Обычно обратно совместимо
- Проверьте changelog библиотеки перед обновлением

---

## Заключение

Система использует три разных подхода к хранению паролей в зависимости от требований безопасности и удобства использования:

1. **Пользователи системы** - максимальная безопасность через одностороннее хеширование
2. **Администраторы кластера** - баланс между безопасностью и необходимостью расшифровки для использования
3. **Администраторы ИБ** - удобство использования с минимальным хранением на сервере

Каждый подход соответствует своему сценарию использования и уровню риска.

