{% extends "base.html" %}
{% load static %}

{% block title %}–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è - –õ–∞–Ω–¥—ã—à{% endblock %}

{% block content %}
<div class="sidebar">
    <div class="panel">
        <h3>üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
        <button class="btn btn-primary" onclick="showConnectionForm()" style="width: 100%; margin-bottom: 1rem;">
            + –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        </button>
        
        <div id="connectionForm" class="connection-form" style="display: none;">
            {% csrf_token %}
            <div class="form-group">
                <label>–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è:</label>
                <input type="text" id="displayName" placeholder="–ü–µ—Ä–≤—ã–π —Å–µ—Ä–≤–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞...">
            </div>
            <div class="form-group">
                <label>–°–µ—Ä–≤–µ—Ä:</label>
                <input type="text" id="serverHost" placeholder="server_ro01.com">
            </div>
            <div class="form-group">
                <label>–ü–æ—Ä—Ç RAS:</label>
                <input type="number" id="rasPort" value="1545">
            </div>
            <div class="form-group">
                <label>–õ–æ–≥–∏–Ω –∫–ª–∞—Å—Ç–µ—Ä–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                <input type="text" id="clusterAdmin">
            </div>
            <div class="form-group">
                <label>–ü–∞—Ä–æ–ª—å –∫–ª–∞—Å—Ç–µ—Ä–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                <input type="password" id="clusterPassword">
            </div>
            <button class="btn btn-primary" onclick="createConnection()">–°–æ–∑–¥–∞—Ç—å</button>
            <button class="btn" onclick="hideConnectionForm()">–û—Ç–º–µ–Ω–∞</button>
        </div>
        
        <div id="connectionsTree"></div>
    </div>
</div>

<div class="main-content">
    <div class="panel">
        <div id="contentArea">
            <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –õ–∞–Ω–¥—ã—à! üöÇ</h2>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–ª–µ–≤–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞–º–∏ 1–°.</p>
            <div style="margin-top: 2rem;">
                <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; text-align: center;">
                        <h4 id="connectionsCount">0</h4>
                        <p>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–π</p>
                    </div>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; text-align: center;">
                        <h4 id="usersCount">0</h4>
                        <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
                    </div>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; text-align: center;">
                        <h4 id="groupsCount">0</h4>
                        <p>–ì—Ä—É–ø–ø</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let currentView = 'dashboard';

// –ë–∞–∑–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function showConnectionForm() {
    document.getElementById('connectionForm').style.display = 'block';
}

function hideConnectionForm() {
    document.getElementById('connectionForm').style.display = 'none';
}

function showNotification(message, isError = false) {
    const notification = document.getElementById('notification');
    const content = document.getElementById('notificationContent');
    content.innerHTML = message;
    notification.style.display = 'block';
    if (isError) {
        notification.style.borderLeft = '4px solid var(--primary-color)';
    }
}

function hideNotification() {
    document.getElementById('notification').style.display = 'none';
}

function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// –ù–∞–≤–∏–≥–∞—Ü–∏—è
function showDashboard() {
    currentView = 'dashboard';
    updateNavigation();
    document.getElementById('contentArea').innerHTML = `
        <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –õ–∞–Ω–¥—ã—à! üöÇ</h2>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–ª–µ–≤–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞–º–∏ 1–°.</p>
        <div style="margin-top: 2rem;">
            <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; text-align: center;">
                    <h4 id="connectionsCount">0</h4>
                    <p>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–π</p>
                </div>
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; text-align: center;">
                    <h4 id="usersCount">0</h4>
                    <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
                </div>
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; text-align: center;">
                    <h4 id="groupsCount">0</h4>
                    <p>–ì—Ä—É–ø–ø</p>
                </div>
            </div>
        </div>
    `;
    loadStatistics();
}

function updateNavigation() {
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    if (currentView === 'dashboard') {
        document.querySelectorAll('.nav-btn')[0].classList.add('active');
    } else if (currentView === 'users') {
        document.querySelectorAll('.nav-btn')[1].classList.add('active');
    } else if (currentView === 'groups') {
        document.querySelectorAll('.nav-btn')[2].classList.add('active');
    } else if (currentView === 'settings') {
        document.querySelectorAll('.nav-btn')[3].classList.add('active');
    }
}

// –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
async function showUserManagement() {
    currentView = 'users';
    updateNavigation();
    try {
        const response = await fetch('/api/users/list/');
        const data = await response.json();
        
        if (data.success) {
            renderUserManagement(data.users);
        } else {
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ' + data.error, true);
        }
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ' + error.message, true);
    }
}

async function showGroupManagement() {
    currentView = 'groups';
    updateNavigation();
    try {
        const response = await fetch('/api/users/groups/all/');
        const data = await response.json();
        
        if (data.success) {
            renderGroupManagement(data.groups);
        } else {
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø: ' + data.error, true);
        }
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø: ' + error.message, true);
    }
}

function renderUserManagement(users) {
    const contentArea = document.getElementById('contentArea');
    
    let html = `
        <div style="margin-bottom: 2rem;">
            <h2 style="margin-bottom: 0.5rem;">üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>
            <button class="btn btn-primary" onclick="showCreateUserForm()">+ –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–õ–æ–≥–∏–Ω</th>
                    <th>–ò–º—è</th>
                    <th>–§–∞–º–∏–ª–∏—è</th>
                    <th>Email</th>
                    <th>–†–æ–ª—å</th>
                    <th>–ê–∫—Ç–∏–≤–µ–Ω</th>
                    <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥</th>
                    <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    users.forEach(user => {
        const roleBadge = user.role === 'admin' ? 'badge-admin' : 'badge-user';
        const lastLogin = user.last_login ? new Date(user.last_login).toLocaleString('ru-RU') : '–ù–∏–∫–æ–≥–¥–∞';
        const isCurrentUser = user.id === {{ user.id }};
        const activeBtn = user.is_active ? 
            `<button class="btn btn-sm btn-danger" onclick="toggleUserActive(${user.id}, false)" ${isCurrentUser ? 'disabled title="–ù–µ–ª—å–∑—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Å–µ–±—è"' : ''}>üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>` :
            `<button class="btn btn-sm btn-primary" onclick="toggleUserActive(${user.id}, true)">‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>`;
        
        html += `
            <tr>
                <td>${user.id}</td>
                <td><strong>${user.username}</strong></td>
                <td>
                    <span id="firstName-${user.id}">${user.first_name || '-'}</span>
                    <button class="btn btn-sm" onclick="editUserField(${user.id}, 'first_name', '–ò–º—è')">‚úèÔ∏è</button>
                </td>
                <td>
                    <span id="lastName-${user.id}">${user.last_name || '-'}</span>
                    <button class="btn btn-sm" onclick="editUserField(${user.id}, 'last_name', '–§–∞–º–∏–ª–∏—è')">‚úèÔ∏è</button>
                </td>
                <td>
                    <span id="email-${user.id}">${user.email || '-'}</span>
                    <button class="btn btn-sm" onclick="editUserField(${user.id}, 'email', 'Email')">‚úèÔ∏è</button>
                </td>
                <td><span class="badge ${roleBadge}">${user.role}</span></td>
                <td>${user.is_active ? '‚úÖ –î–∞' : '‚ùå –ù–µ—Ç'}</td>
                <td>${lastLogin}</td>
                <td>${new Date(user.date_joined).toLocaleDateString('ru-RU')}</td>
                <td>
                    <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                        <button class="btn btn-sm" onclick="manageUserGroups(${user.id}, '${user.username}')">üë• –ì—Ä—É–ø–ø—ã</button>
                        <button class="btn btn-sm btn-secondary" onclick="showChangePasswordForm(${user.id}, '${user.username}')">üîë –ü–∞—Ä–æ–ª—å</button>
                        ${activeBtn}
                    </div>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    contentArea.innerHTML = html;
}

function renderGroupManagement(groups) {
    const contentArea = document.getElementById('contentArea');
    
    let html = `
        <div style="margin-bottom: 2rem;">
            <h2 style="margin-bottom: 0.5rem;">üìÅ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–∞–º–∏</h2>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–°–æ–∑–¥–∞—Ç–µ–ª—å</th>
                    <th>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤</th>
                    <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    groups.forEach(group => {
        html += `
            <tr>
                <td>${group.id}</td>
                <td>
                    <span id="groupName-${group.id}"><strong>${group.name}</strong></span>
                    <button class="btn btn-sm" onclick="editGroupName(${group.id}, '${group.name}')">‚úèÔ∏è</button>
                </td>
                <td>${group.created_by}</td>
                <td>${group.members_count}</td>
                <td>${new Date(group.created_at).toLocaleDateString('ru-RU')}</td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="deleteGroup(${group.id}, '${group.name}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    contentArea.innerHTML = html;
}

// –§—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–∏—è
function showCreateUserForm() {
    const contentArea = document.getElementById('contentArea');
    
    const formHtml = `
        <div style="max-width: 500px;">
            <h3>üë§ –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
            <div class="connection-form">
                <div class="form-group">
                    <label>–õ–æ–≥–∏–Ω:</label>
                    <input type="text" id="newUsername" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω" required>
                </div>
                <div class="form-group">
                    <label>–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="newPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required>
                </div>
                <div class="form-group">
                    <label>–†–æ–ª—å:</label>
                    <select id="newUserRole">
                        <option value="user">üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
                        <option value="admin">‚öôÔ∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Email (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                    <input type="email" id="newUserEmail" placeholder="email@example.com">
                </div>
                <div class="form-group">
                    <label>–ò–º—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                    <input type="text" id="newUserFirstName" placeholder="–ò–≤–∞–Ω">
                </div>
                <div class="form-group">
                    <label>–§–∞–º–∏–ª–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                    <input type="text" id="newUserLastName" placeholder="–ò–≤–∞–Ω–æ–≤">
                </div>
                <button class="btn btn-primary" onclick="createNewUser()">‚úÖ –°–æ–∑–¥–∞—Ç—å</button>
                <button class="btn" onclick="showUserManagement()">‚ùå –û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    `;
    
    contentArea.innerHTML = formHtml;
}

async function createNewUser() {
    const userData = {
        username: document.getElementById('newUsername').value,
        password: document.getElementById('newPassword').value,
        role: document.getElementById('newUserRole').value,
        email: document.getElementById('newUserEmail').value,
        first_name: document.getElementById('newUserFirstName').value,
        last_name: document.getElementById('newUserLastName').value
    };
    
    if (!userData.username || !userData.password) {
        showNotification('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å', true);
        return;
    }
    
    try {
        const response = await fetch('/api/users/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify(userData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω');
            showUserManagement();
        } else {
            showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + result.error, true);
        }
    } catch (error) {
        showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + error.message, true);
    }
}

// –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
function editUserField(userId, field, fieldName) {
    const currentValue = document.getElementById(`${field}-${userId}`).textContent;
    const newValue = prompt(`–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ ${fieldName.toLowerCase()}:`, currentValue === '-' ? '' : currentValue);
    
    if (newValue !== null) {
        fetch('/api/users/update/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                user_id: userId,
                [field]: newValue
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showNotification(`‚úÖ ${fieldName} —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω`);
                document.getElementById(`${field}-${userId}`).textContent = newValue || '-';
            } else {
                showNotification(`‚ùå –û—à–∏–±–∫–∞: ${result.error}`, true);
            }
        })
        .catch(error => {
            showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, true);
        });
    }
}

function showChangePasswordForm(userId, username) {
    const newPassword = prompt(`–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${username}":`, '');
    
    if (newPassword) {
        const requireChange = confirm('–¢—Ä–µ–±–æ–≤–∞—Ç—å —Å–º–µ–Ω—É –ø–∞—Ä–æ–ª—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –≤—Ö–æ–¥–µ?');
        
        fetch('/api/users/change-password/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                user_id: userId,
                new_password: newPassword,
                require_change: requireChange
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showNotification('‚úÖ –ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω');
            } else {
                showNotification(`‚ùå –û—à–∏–±–∫–∞: ${result.error}`, true);
            }
        })
        .catch(error => {
            showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, true);
        });
    }
}

function toggleUserActive(userId, isActive) {
    const action = isActive ? '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å';
    
    if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${action} —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?`)) {
        fetch('/api/users/toggle-active/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                user_id: userId,
                is_active: isActive
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showNotification(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${action === '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' ? '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'}`);
                showUserManagement(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
            } else {
                showNotification(`‚ùå –û—à–∏–±–∫–∞: ${result.error}`, true);
            }
        })
        .catch(error => {
            showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, true);
        });
    }
}

function editGroupName(groupId, currentName) {
    const newName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã:', currentName);
    
    if (newName && newName !== currentName) {
        fetch('/api/users/groups/update/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                group_id: groupId,
                new_name: newName
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showNotification('‚úÖ –ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–æ');
                showGroupManagement(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
            } else {
                showNotification(`‚ùå –û—à–∏–±–∫–∞: ${result.error}`, true);
            }
        })
        .catch(error => {
            showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, true);
        });
    }
}

// –§—É–Ω–∫—Ü–∏–∏ —É–¥–∞–ª–µ–Ω–∏—è
async function deleteUser(userId, username) {
    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${username}"?`)) {
        return;
    }
    
    showNotification('–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
    showNotification('–§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
}

async function deleteGroup(groupId, groupName) {
    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É "${groupName}"?`)) {
        return;
    }
    
    try {
        const response = await fetch('/api/users/groups/delete/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                group_id: groupId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('‚úÖ –ì—Ä—É–ø–ø–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞');
            showGroupManagement(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
        } else {
            showNotification(`‚ùå –û—à–∏–±–∫–∞: ${result.error}`, true);
        }
    } catch (error) {
        showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, true);
    }
}

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function manageUserGroups(userId, username) {
    try {
        const [groupsResponse, userGroupsResponse] = await Promise.all([
            fetch('/api/users/groups/all/'),
            fetch('/api/users/groups/')
        ]);
        
        const groupsData = await groupsResponse.json();
        const userGroupsData = await userGroupsResponse.json();
        
        if (!groupsData.success) {
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø', true);
            return;
        }
        
        renderUserGroupsManagement(userId, username, groupsData.groups, userGroupsData.groups || []);
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞: ' + error.message, true);
    }
}

function renderUserGroupsManagement(userId, username, allGroups, userGroups) {
    const contentArea = document.getElementById('contentArea');
    
    const userGroupIds = userGroups.map(g => g.id);
    
    let html = `
        <div style="margin-bottom: 1rem;">
            <button class="btn" onclick="showUserManagement()">‚Üê –ù–∞–∑–∞–¥ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</button>
        </div>
        <h2>üë• –ì—Ä—É–ø–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${username}</h2>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 2rem;">
            <div>
                <h4>–î–æ—Å—Ç—É–ø–Ω—ã–µ –≥—Ä—É–ø–ø—ã</h4>
                <div style="max-height: 400px; overflow-y: auto;">
    `;
    
    allGroups.forEach(group => {
        if (!userGroupIds.includes(group.id)) {
            html += `
                <div class="tree-node" style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${group.name}</strong>
                        <div style="font-size: 0.8rem; color: #666;">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${group.members_count}</div>
                    </div>
                    <button class="btn btn-sm btn-primary" onclick="toggleGroupMembership(${userId}, ${group.id}, 'add')">‚úÖ –î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
            `;
        }
    });
    
    html += `
                </div>
            </div>
            <div>
                <h4>–ì—Ä—É–ø–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h4>
                <div style="max-height: 400px; overflow-y: auto;">
    `;
    
    allGroups.forEach(group => {
        if (userGroupIds.includes(group.id)) {
            html += `
                <div class="tree-node" style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${group.name}</strong>
                        <div style="font-size: 0.8rem; color: #666;">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${group.members_count}</div>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="toggleGroupMembership(${userId}, ${group.id}, 'remove')">‚ùå –£–¥–∞–ª–∏—Ç—å</button>
                </div>
            `;
        }
    });
    
    html += `
                </div>
            </div>
        </div>
    `;
    
    contentArea.innerHTML = html;
}

async function toggleGroupMembership(userId, groupId, action) {
    try {
        const response = await fetch('/api/users/groups/assign/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                user_id: userId,
                group_id: groupId,
                action: action
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${action === 'add' ? '–¥–æ–±–∞–≤–ª–µ–Ω –≤' : '—É–¥–∞–ª–µ–Ω –∏–∑'} –≥—Ä—É–ø–ø—É`);
            const userResponse = await fetch('/api/users/list/');
            const userData = await userResponse.json();
            if (userData.success) {
                const user = userData.users.find(u => u.id === userId);
                if (user) {
                    manageUserGroups(userId, user.username);
                }
            }
        } else {
            showNotification('‚ùå –û—à–∏–±–∫–∞: ' + result.error, true);
        }
    } catch (error) {
        showNotification('‚ùå –û—à–∏–±–∫–∞: ' + error.message, true);
    }
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–º–∏
async function loadConnections() {
    try {
        const response = await fetch('/api/clusters/connections/');
        const data = await response.json();
        
        if (data.connections) {
            renderConnectionsTree(data.connections);
        }
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π: ' + error.message, true);
    }
}

function renderConnectionsTree(connections) {
    const treeContainer = document.getElementById('connectionsTree');
    treeContainer.innerHTML = '';
    
    connections.forEach(conn => {
        const node = document.createElement('div');
        node.className = 'tree-node';
        node.innerHTML = `
            <div>
                <strong>${conn.display_name}</strong>
                <div style="font-size: 0.8rem; color: #666;">${conn.server_host}:${conn.ras_port}</div>
            </div>
        `;
        node.onclick = () => loadConnectionData(conn.id);
        treeContainer.appendChild(node);
    });
}

async function createConnection() {
    const displayName = document.getElementById('displayName')?.value;
    const serverHost = document.getElementById('serverHost')?.value;
    const rasPort = document.getElementById('rasPort')?.value;
    const clusterAdmin = document.getElementById('clusterAdmin')?.value;
    const clusterPassword = document.getElementById('clusterPassword')?.value;
    
    if (!displayName || !serverHost || !rasPort) {
        showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è, –°–µ—Ä–≤–µ—Ä –∏ –ü–æ—Ä—Ç RAS', true);
        return;
    }
    
    const connectionData = {
        display_name: displayName,
        server_host: serverHost,
        ras_port: parseInt(rasPort),
        cluster_admin: clusterAdmin || '',
        cluster_password: clusterPassword || ''
    };
    
    try {
        const response = await fetch('/api/clusters/connections/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify(connectionData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ');
            hideConnectionForm();
            loadConnections();
            loadStatistics();
            
            document.getElementById('displayName').value = '';
            document.getElementById('serverHost').value = '';
            document.getElementById('rasPort').value = '1545';
            document.getElementById('clusterAdmin').value = '';
            document.getElementById('clusterPassword').value = '';
        } else {
            showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + result.error, true);
        }
    } catch (error) {
        showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message, true);
    }
}

function loadConnectionData(connectionId) {
    showNotification('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ' + connectionId);
}

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
async function loadStatistics() {
    try {
        const [connResponse, usersResponse, groupsResponse] = await Promise.all([
            fetch('/api/clusters/connections/'),
            fetch('/api/users/list/'),
            fetch('/api/users/groups/all/')
        ]);
        
        const connData = await connResponse.json();
        const usersData = await usersResponse.json();
        const groupsData = await groupsResponse.json();
        
        if (connData.connections) {
            document.getElementById('connectionsCount').textContent = connData.connections.length;
        }
        if (usersData.success) {
            document.getElementById('usersCount').textContent = usersData.users.length;
        }
        if (groupsData.success) {
            document.getElementById('groupsCount').textContent = groupsData.groups.length;
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
    }
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å–∏—Å—Ç–µ–º—ã
async function showSystemSettings() {
    currentView = 'settings';
    updateNavigation();
    try {
        const response = await fetch('/api/system/settings/');
        const data = await response.json();
        
        if (data.success) {
            renderSystemSettings(data.settings);
        } else {
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫: ' + data.error, true);
        }
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫: ' + error.message, true);
    }
}

function renderSystemSettings(settings) {
    const contentArea = document.getElementById('contentArea');
    
    let html = `
        <div style="margin-bottom: 2rem;">
            <h2 style="margin-bottom: 0.5rem;">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã</h2>
        </div>
        
        <div style="max-width: 600px;">
            <div class="connection-form">
                <h4>üîß –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h4>
                
                <div class="form-group">
                    <label>–ü—É—Ç—å –∫ —É—Ç–∏–ª–∏—Ç–µ RAC:</label>
                    <input type="text" id="rac_path" value="${settings.rac_path}" placeholder="/opt/1cv8/x86_64/8.3.27.1860/rac">
                    <small style="color: #666;">–ê–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∫ –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–º—É —Ñ–∞–π–ª—É rac</small>
                </div>
                
                <div class="form-group">
                    <label>–¢–∞–π–º–∞—É—Ç —Å–µ—Å—Å–∏–∏ (—Å–µ–∫—É–Ω–¥—ã):</label>
                    <input type="number" id="session_timeout" value="${settings.session_timeout}">
                    <small style="color: #666;">–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç RAC</small>
                </div>
                
                <div class="form-group">
                    <label>–ú–∞–∫—Å–∏–º—É–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π:</label>
                    <input type="number" id="max_connections" value="${settings.max_connections}">
                    <small style="color: #666;">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –∫ —Å–µ—Ä–≤–µ—Ä–∞–º 1–°</small>
                </div>
            </div>
            
            <div class="connection-form" style="margin-top: 1rem;">
                <h4>üìß –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h4>
                
                <div class="form-group">
                    <label>SMTP —Å–µ—Ä–≤–µ—Ä:</label>
                    <input type="text" id="smtp_server" value="${settings.smtp_server}" placeholder="smtp.example.com">
                </div>
                
                <div class="form-group">
                    <label>SMTP –ø–æ—Ä—Ç:</label>
                    <input type="number" id="smtp_port" value="${settings.smtp_port}">
                </div>
                
                <div class="form-group">
                    <label>Email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:</label>
                    <input type="email" id="notification_email" value="${settings.notification_email}" placeholder="admin@example.com">
                </div>
            </div>
            
            <div class="connection-form" style="margin-top: 1rem;">
                <h4>‚ö° –ü—Ä–æ—á–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h4>
                
                <div class="form-group">
                    <label>–£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:</label>
                    <select id="log_level">
                        <option value="DEBUG" ${settings.log_level === 'DEBUG' ? 'selected' : ''}>DEBUG</option>
                        <option value="INFO" ${settings.log_level === 'INFO' ? 'selected' : ''}>INFO</option>
                        <option value="WARNING" ${settings.log_level === 'WARNING' ? 'selected' : ''}>WARNING</option>
                        <option value="ERROR" ${settings.log_level === 'ERROR' ? 'selected' : ''}>ERROR</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="backup_enabled" ${settings.backup_enabled === 'true' ? 'checked' : ''}>
                        –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
                    </label>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="saveSystemSettings()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            <button class="btn" onclick="showDashboard()">‚ùå –û—Ç–º–µ–Ω–∞</button>
        </div>
    `;
    
    contentArea.innerHTML = html;
}

async function saveSystemSettings() {
    const settings = {
        rac_path: document.getElementById('rac_path').value,
        session_timeout: document.getElementById('session_timeout').value,
        max_connections: document.getElementById('max_connections').value,
        log_level: document.getElementById('log_level').value,
        backup_enabled: document.getElementById('backup_enabled').checked ? 'true' : 'false',
        smtp_server: document.getElementById('smtp_server').value,
        smtp_port: document.getElementById('smtp_port').value,
        notification_email: document.getElementById('notification_email').value,
    };
    
    try {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∂–¥—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É –æ—Ç–¥–µ–ª—å–Ω–æ
        const promises = Object.entries(settings).map(([key, value]) => 
            fetch('/api/system/settings/update/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({ key, value })
            })
        );
        
        const results = await Promise.all(promises);
        const allSuccess = results.every(response => response.ok);
        
        if (allSuccess) {
            showNotification('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
        } else {
            showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫', true);
        }
    } catch (error) {
        showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫: ' + error.message, true);
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    loadConnections();
    loadStatistics();
    updateNavigation();
});
</script>
{% endblock %}