# Структура проекта Ландыш

## Описание организации файлов

### Backend (Django приложения)

#### `core/` - Основные функции системы
- **models.py** - Модели: Profile, SystemSettings
- **views.py** - Системные настройки, принудительная смена пароля
- **forms.py** - Формы аутентификации и смены пароля
- **middleware.py** - Middleware для принудительной смены пароля
- **context_processors.py** - Глобальные переменные для шаблонов
- **logging_filters.py** - Фильтры логирования (RequireLoggingEnabled)
- **admin.py** - Админ-панель Django
- **urls.py** - URL маршруты для системных настроек
- **management/commands/** - Django команды (create_admin)

#### `users/` - Управление пользователями
- **models.py** - Модели: UserGroup
- **views.py** - CRUD пользователей, управление группами, ролями
- **urls.py** - API endpoints для пользователей и групп
- **forms.py** - Формы для работы с пользователями
- **admin.py** - Админ-панель для пользователей

#### `clusters/` - Управление кластерами и подключениями
- **models.py** - Модели: ServerConnection, ConnectionFolder
- **views.py** - API endpoints для подключений, кластеров, информационных баз, сеансов, процессов, менеджеров, администраторов, агентов
- **views_folders.py** - API endpoints для управления папками подключений (CRUD)
- **rac_client.py** - Клиент для работы с RAC (1C): класс RACClient, функция fix_broken_encoding
- **urls.py** - URL маршруты для кластеров
- **admin.py** - Админ-панель для подключений

#### `frontend/` - Фронтенд приложение
- **views.py** - Главная страница (dashboard)
- **urls.py** - URL маршруты фронтенда
- **static/frontend/** - Статические файлы
  - **css/main.css** - Все стили приложения
  - **js/** - JavaScript модули:
    - **app.js** - Инициализация приложения, выпадающее меню пользователя
    - **utils.js** - Утилиты (уведомления, CSRF, localStorage)
    - **navigation.js** - Навигация и переключение разделов
    - **confirm-modal.js** - Модальное окно подтверждения (замена confirm())
    - **users.js** - Управление пользователями
    - **groups.js** - Управление группами
    - **settings.js** - Настройки системы
    - **statistics.js** - Статистика системы
    - **rules.js** - Управление требованиями назначения функциональности (ТНФ)
    - **connections.js** - Главный файл подключений (импорты и общие функции)
    - **connections-core.js** - Основная работа с подключениями (CRUD, папки, drag & drop)
    - **connections-folders.js** - Управление папками подключений
    - **connections-clusters.js** - Работа с кластерами
    - **connections-infobases.js** - Работа с информационными базами
    - **connections-sessions.js** - Работа с сеансами
    - **connections-processes.js** - Работа с рабочими процессами
    - **connections-managers.js** - Работа с менеджерами кластера
    - **connections-admins.js** - Работа с администраторами кластера
    - **connections-agents.js** - Работа с агентами кластера
    - **connections-servers.js** - Работа с рабочими серверами
    - **connections-utils.js** - Утилиты для подключений
    - **connections-dragdrop.js** - Drag & Drop функциональность для перетаскивания подключений

#### `config/` - Конфигурация проекта
- **settings.py** - Настройки Django
- **urls.py** - Главный файл URL маршрутов
- **wsgi.py** - WSGI конфигурация

### Templates (Шаблоны)

#### `templates/base.html` - Базовый шаблон
- Основная структура HTML
- Подключение CSS и JS
- Уведомления

#### `templates/frontend/` - Шаблоны фронтенда
- **index.html** - Главная страница
- **partials/_sidebar.html** - Боковая панель с подключениями
- **partials/_welcome.html** - Приветственный блок со статистикой

#### `templates/registration/` - Шаблоны аутентификации
- **login.html** - Страница входа
- **force_password_change.html** - Принудительная смена пароля

### Скрипты и конфигурация

- **manage.py** - Django management script
- **requirements.txt** - Зависимости Python
- **deploy.sh** - Скрипт развертывания
- **run.ps1** - PowerShell скрипт запуска
- **push.ps1** - PowerShell скрипт для push операций
- **django-landysh.service** - Systemd service файл
- **db.sqlite3** - База данных SQLite (по умолчанию)

### Логика организации

1. **Разделение по функциональности**: Каждое Django приложение отвечает за свою область
2. **Модульность JavaScript**: 
   - Основные модули (app.js, utils.js, navigation.js) для базовой функциональности
   - Модули connections-*.js разбиты по функциональности (сеансы, процессы, кластеры и т.д.)
   - Каждый модуль отвечает за свою область функциональности
3. **Единый CSS файл**: Все стили в одном месте для простоты поддержки
4. **Частичные шаблоны**: Переиспользуемые компоненты в `partials/`
5. **Разделение views**: views.py для основной логики, views_folders.py для папок

### Основные модели данных

#### `core.models`
- **Profile** - Профиль пользователя (роль, политика паролей, принудительная смена)
- **SystemSettings** - Системные настройки (ключ-значение)

#### `users.models`
- **UserGroup** - Группы пользователей для организации доступа

#### `clusters.models`
- **ServerConnection** - Подключения к серверам 1С (host, port, учетные данные)
- **ConnectionFolder** - Папки для организации подключений (иерархия, порядок сортировки)

### RAC Client (rac_client.py)

Класс `RACClient` предоставляет методы для работы с утилитой RAC 1С:
- Управление кластерами (list, info, update)
- Управление информационными базами (list, info, update, create, drop)
- Управление сеансами (list, terminate, interrupt)
- Управление рабочими процессами (list, info, update)
- Управление менеджерами (list, info)
- Управление администраторами (list, create, delete)
- Управление агентами (list, info)
- Управление рабочими серверами (list, info, update)

Функция `fix_broken_encoding()` исправляет проблемы с кодировкой в выводе RAC.

### Рекомендации по добавлению новых функций

1. **Новый функционал для пользователей** → `users/views.py` и `frontend/static/frontend/js/users.js`
2. **Новый функционал для кластеров** → `clusters/views.py` и соответствующий модуль `connections-*.js`
3. **Новый функционал для групп** → `users/views.py` и `frontend/static/frontend/js/groups.js`
4. **Новые системные настройки** → `core/views.py` и `frontend/static/frontend/js/settings.js`
5. **Новые RAC команды** → `clusters/rac_client.py` (добавить метод в класс RACClient)
6. **Новые стили** → `frontend/static/frontend/css/main.css`
7. **Новые модальные окна** → создать отдельный JS модуль или добавить в соответствующий connections-*.js
8. **Новые модели** → добавить в соответствующий `models.py` и создать миграции

### Особенности архитектуры

1. **Хранение состояния в localStorage**:
   - Состояние сворачивания папок
   - Учетные данные администраторов (кластера и ИБ)
   - Порядок столбцов в таблицах
   - Видимые столбцы в таблицах

2. **Модальные окна**:
   - Используется единый стиль модальных окон
   - `confirm-modal.js` заменяет стандартный `confirm()` браузера
   - Модальные окна для свойств кластеров, ИБ, сеансов и т.д.

3. **Drag & Drop**:
   - Перетаскивание подключений между папками
   - Изменение порядка подключений
   - Изменение порядка столбцов в таблицах

4. **Фильтрация и поиск**:
   - Общий поиск по таблицам
   - Поиск по отдельным столбцам
   - Фильтр видимых столбцов

5. **Экспорт данных**:
   - Экспорт таблиц в Excel (сеансы, процессы, менеджеры)

### Удалённые неиспользуемые файлы

- `templates/core/dashboard.html` - пустой файл
- `templates/registration/logout.html` - не используется (Django использует встроенный view)
- `core/utils/` - пустая папка
